---
title: PHP Mailer CVE-2021-3603
categories: 漏洞复现
---
# 介绍
phpMailer 是一个非常强大的 php发送邮件类,可以设定发送邮件地址、回复地址、邮件主题、html网页,上传附件,并且使用起来非常方便。

PHPMailer是一个用来发送电子邮件的函数包，远比PHP提供的mail()方便易用。

V6.5.0已修复

参考：[PHP Mailer 最新代码执行漏洞](https://xz.aliyun.com/t/9766#toc-5)

<!--more-->
---

# 环境搭建
## 1.采用composer快速搭建

>composer require phpmailer/phpmailer 6.4.1

## 2.直接下载源码包
> wget https://github.com/PHPMailer/PHPMailer/archive/refs/tags/v6.4.1.tar.gz

复现时直接新建一个index.php

```p
<?php
use PHPMailer\PHPMailer\PHPMailer;
require 'src/PHPMailer.php';
$mail = new PHPMailer();
var_dump($mail);
?>
```

---
# 漏洞复现
## 漏洞分析
调用`validateAddress()函数`进行检验时，如果其中可选参数`$patternselect`可控的话，那么可以造成任意调用函数进行代码执行，如果不可控的话，默认则为php,如果项目中存在一个危险的函数`名称为php函数`，则可以进行`调用该危险函数`进行利用。

## 漏洞证明
(1) 可控两个参数

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210630112459189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzMjYzNzg5,size_16,color_FFFFFF,t_70#pic_center)

---
(2) 只控`address`参数, 则需要全局注册一个名称为php的危险函数:

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210630112531628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzMjYzNzg5,size_16,color_FFFFFF,t_70#pic_center)

## 分析过程
在PHPMailer.php第1333行


![](https://img-blog.csdnimg.cn/20210630112756355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzMjYzNzg5,size_16,color_FFFFFF,t_70#pic_center)

- 
可以看到如果`$patternselect`不为空，就可以直接进行任意函数调用:

```p
if (is_callable($patternselect)) {
            return call_user_func($patternselect, $address);
```

那么如果不赋值的，默认情况是则会进行赋值:
```p
$patternselect = static::$validator;
```

而这个值，已经被预定好了，名为 " php "

![](https://img-blog.csdnimg.cn/2021063011321357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzMjYzNzg5,size_16,color_FFFFFF,t_70#pic_center)
然后就会优先执行全局注册的php函数，比如上面那个例子，从而导致命令执行。


